<script>
'use strict';

/**
 * @nosideeffects
 * @return Array
 */
function getRoutes() {
    var json = localStorage.routes;
    if (!json) {
        return [];
    }

    var routes = JSON.parse(json);
    for (var i = 0; i < routes.length; i++) {
        routes[i].match = new RegExp(routes[i].match);
    }
    return routes;
}

/**
 * @param {Object} request
 * @nosideeffects
 * @return string
 */
function getBackend(request) {
    var routes = getRoutes();
    for (var i = 0; i < routes.length; i++) {
        var route = routes[i];
        if (route.match.test(request.url) && route[request.type]) {
            return route.to;
        }
    }
    return '';
}

/**
 * @param {Object} request
 * @param {MessageSender} sender
 * @param {Function} sendResponse
 */
function onRequest(request, sender, sendResponse) {
    if (request.method == 'getBackend') {
        sendResponse(getBackend(request));
    } else if (request.method == 'send') {
        var xhr = new XMLHttpRequest();
        xhr.open('POST', request.url);

        var headers = request.headers;
        for (var key in headers) {
            xhr.setRequestHeader(key, headers[key]);
        }

        xhr.send(request.content);
    }
}


chrome.extension.onRequest.addListener(onRequest);
chrome.extension.onRequestExternal.addListener(onRequest);
</script>
