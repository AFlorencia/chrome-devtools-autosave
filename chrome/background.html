<script>
'use strict';

/**
 * @nosideeffects
 * @return Array
 */
function getRoutes() {
    var json = localStorage.routes;
    if (!json) {
        return [];
    }

    return JSON.parse(json).filter(function(route) {
        return !route._disabled;
    }).map(function(route) {
        route.match = new RegExp(route.match);
        return route;
    });
}

/**
 * @param {Object} request
 * @nosideeffects
 * @return string
 */
function getBackend(request) {
    var routes = getRoutes();
    for (var i = 0; i < routes.length; i++) {
        var route = routes[i];
        var matched;
        if (route[request.type] && (matched = request.url.match(route.match))) {
            var result = route.to;
            for (var j = 0; j < matched.length; j++) {
                result = result.replace(new RegExp('\\$' + j, 'g'), matched[j]);
            }
            return result;
        }
    }
    return '';
}

/**
 * @param {Object} request
 * @param {MessageSender} sender
 * @param {Function} sendResponse
 */
function onRequest(request, sender, sendResponse) {
    if (request.method == 'getBackend') {
        sendResponse(getBackend(request));
    } else if (request.method == 'send') {
        var xhr = new XMLHttpRequest();
        xhr.open('POST', request.url);

        var headers = request.headers;
        for (var key in headers) {
            xhr.setRequestHeader(key, headers[key]);
        }

        xhr.send(request.content);
    }
}


chrome.extension.onRequest.addListener(onRequest);
chrome.extension.onRequestExternal.addListener(onRequest);
</script>
